# CVE2020-24346

[related Document](https://github.com/nginx/njs/issues/325)

## ffmalloc
Program execution doesn't have any output. So we couldn't determine if the ffmalloc has prevent the UAF bug. So we marked as `CANNOT_DETERMINE`.

## Use After Free (UAF)
UAF occurs at `src/njs_json.c:1030`
```c
static njs_int_t
njs_json_parse_iterator_call(njs_vm_t *vm, njs_json_parse_t *parse,
    njs_json_state_t *state)
{
    // ...

    case NJS_PROPERTY_REF:
        value = prop->value.data.u.value;
        arguments[2] = *value;

        ret = njs_function_apply(vm, parse->function, arguments, 3,
                                 &parse->retval);
        if (njs_slow_path(ret != NJS_OK)) {
            return ret;
        }

        /*
         * The njs_function_apply() function can convert fast array to object.
         * After this conversion, there will be garbage in the value.
         */

        if (njs_fast_path(njs_is_fast_array(&state->value)
            && (state->index - 1) < njs_array(&state->value)->length))
        {
            if (njs_is_undefined(&parse->retval)) {
                njs_set_invalid(value); // This point!

            } else {
                *value = parse->retval;
            }

            break;
        }

        if (njs_is_undefined(&parse->retval)) {
            ret = njs_value_property_i64_delete(vm, &state->value,
                                                state->index - 1, NULL);

        } else {
            ret = njs_value_property_i64_set(vm, &state->value,
                                             state->index - 1, &parse->retval);
        }

        if (njs_slow_path(ret == NJS_ERROR)) {
            return NJS_ERROR;
        }

        break;

    // ...

    return NJS_OK;
}
```