# CVE2019-17582

[related Document](https://github.com/nih-at/libzip/issues/5)

## Analyze with ASAN
```
# ziptool $FILE cat index
==1771==ERROR: AddressSanitizer: heap-use-after-free on address 0x6030000000d1 at pc 0x7f267d085fc1 bp 0x7ffed21f65f0 sp 0x7ffed21f65e8                                                                           
READ of size 1 at 0x6030000000d1 thread T0                                                                                                                                                                        
    #0 0x7f267d085fc0 in _zip_buffer_free /var/tmp/portage/dev-libs/libzip-1.2.0/work/libzip-1.2.0/lib/zip_buffer.c:53:17                                                                                         
    #1 0x7f267d092646 in _zip_dirent_read /var/tmp/portage/dev-libs/libzip-1.2.0/work/libzip-1.2.0/lib/zip_dirent.c                                                                                               
    #2 0x7f267d0aabfe in _zip_read_cdir /var/tmp/portage/dev-libs/libzip-1.2.0/work/libzip-1.2.0/lib/zip_open.c:380:69                                                                                            
    #3 0x7f267d0aabfe in _zip_find_central_dir /var/tmp/portage/dev-libs/libzip-1.2.0/work/libzip-1.2.0/lib/zip_open.c:613                                                                                        
    #4 0x7f267d0aabfe in _zip_open /var/tmp/portage/dev-libs/libzip-1.2.0/work/libzip-1.2.0/lib/zip_open.c:200                                                                                                    
    #5 0x7f267d0a89b7 in zip_open_from_source /var/tmp/portage/dev-libs/libzip-1.2.0/work/libzip-1.2.0/lib/zip_open.c:148:11                                                                                      
    #6 0x7f267d0a7e93 in zip_open /var/tmp/portage/dev-libs/libzip-1.2.0/work/libzip-1.2.0/lib/zip_open.c:74:15                                                                                                   
    #7 0x513392 in read_from_file /var/tmp/portage/dev-libs/libzip-1.2.0/work/libzip-1.2.0/src/ziptool.c:698:13                                                                                                   
    #8 0x513392 in main /var/tmp/portage/dev-libs/libzip-1.2.0/work/libzip-1.2.0/src/ziptool.c:1113                                                                                                               
    #9 0x7f267c1b5680 in __libc_start_main /var/tmp/portage/sys-libs/glibc-2.23-r4/work/glibc-2.23/csu/../csu/libc-start.c:289                                                                                    
    #10 0x41b058 in _init (/usr/bin/ziptool+0x41b058)  
```

## BUDAlloc-detection in GDB
```
Program received signal SIGSEGV, Segmentation fault.
_zip_buffer_free (buffer=buffer@entry=0x1001003a1120) at zip_buffer.c:53
53	    if (buffer->free_data) {
#0  _zip_buffer_free (buffer=buffer@entry=0x1001003a1120) at zip_buffer.c:53
#1  0x00007ffff7f441ae in _zip_dirent_read (zde=0x100100257100, src=<optimized out>, buffer=0x1001003a1120, buffer@entry=0x0, local=local@entry=false, error=error@entry=0x7fffffffdfd0) at zip_dirent.c:582
#2  0x00007ffff7f4919f in _zip_read_cdir (error=0x7fffffffdfd0, buf_offset=65574, buffer=0x10010039b060, za=0x100100256080) at zip_open.c:380
#3  _zip_find_central_dir (len=<optimized out>, za=0x100100256080) at zip_open.c:613
#4  _zip_open (src=src@entry=0x10010021a050, flags=1, error=error@entry=0x7fffffffe120) at zip_open.c:200
#5  0x00007ffff7f49b39 in zip_open_from_source (src=src@entry=0x10010021a050, _flags=_flags@entry=1, error=error@entry=0x7fffffffe120) at zip_open.c:148
#6  0x00007ffff7f49dc8 in zip_open (fn=<optimized out>, _flags=1, zep=0x7fffffffe1a0) at zip_open.c:74
#7  0x0000555555557bef in read_from_file (length=0, offset=0, error=0x7fffffffe190, flags=1, archive=0x7fffffffe708 "./poc") at ziptool.c:698
#8  main (argc=4, argv=0x7fffffffe428) at ziptool.c:1113
```

## Explanation
Address Sanitizer reports that ziptool causes Use After Free on `zip_buffer.c:53`. Our BUDAlloc-d generates SIGSEGV exactly at the same point, which means that it **DETECT** the UAF.